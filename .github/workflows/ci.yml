# Pre-requisites:
# - In repository settings -> Security -> Secrets and variables -> Actions:
#    - Add SONAR_TOKEN secret with your SonarCloud token
#    - Add SONAR_ORGANIZATION and SONAR_PROJECT_KEY as Variables
name: SonarCloud Analysis

on:
    push:
        branches:
            - main
            - cpp_arduino
    pull_request:
        branches:
            - main
            - cpp_arduino

permissions:
    contents: read
    issues: write
    pull-requests: write
    checks: write

jobs:
    sonar:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Python & PlatformIO
              run: |
                  sudo apt update
                  sudo apt install -y gcc g++ make python3-pip lcov unzip wget gcovr
                  pip3 install platformio

            - name: Setup SonarScanner
              run: |
                  wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
                  unzip sonar-scanner-cli-5.0.1.3006-linux.zip
                  echo "$PWD/sonar-scanner-5.0.1.3006-linux/bin" >> $GITHUB_PATH

            - name: Run native tests
              run: |
                  mkdir -p test-results
                  pio test -e test_native --junit-output-path test-results/results.xml || true

            - name: Generate coverage data
              run: |
                  # Remove previous .gcov files
                  find . -name "*.gcov" -delete
                  # Run gcov from repo root for all .gcno files
                  find .pio/build/test_native -name "*.gcno" -exec gcov -b -l -p -c {} \;
                  # Generate coverage.xml for src and include
                  gcovr --xml-pretty \
                    --root $GITHUB_WORKSPACE \
                    --object-directory .pio/build/test_native \
                    --filter "src|include" \
                    --exclude-throw-branches \
                    --exclude-directories ".*libdeps.*" \
                    --exclude ".*FakeIt.*" \
                    --exclude ".*Arduino.*" \
                    --exclude ".*unity.*" \
                    --exclude "/usr/include/.*" \
                    --exclude-lines-by-pattern ".*#ifdef ESP_PLATFORM.*" \
                    --exclude-lines-by-pattern ".*#if defined\(ESP_PLATFORM\).*" \
                    --exclude-unreachable-branches \
                    -o coverage.xml \
                    --print-summary

            - name: Fix shallow clone for SonarCloud
              run: |
                  git fetch --prune --unshallow || true
                  git fetch origin +refs/heads/main:refs/remotes/origin/main || true

            - name: SonarCloud Scan
              run: |
                  sonar-scanner \
                    -Dsonar.host.url=https://sonarcloud.io \
                    -Dsonar.organization=${{ vars.SONAR_ORGANIZATION }} \
                    -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }} \
                    -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
                    -Dsonar.sources=src,include \
                    -Dsonar.tests=test \
                    -Dsonar.exclusions=**/libdeps/**/*,**/.pio/**/*,**/examples/**/* \
                    -Dsonar.coverage.exclusions=**/test/**/*,**/libdeps/**/*,**.github/**/*,**/examples/**/* \
                    -Dsonar.cfamily.gcov.reportsPath=. \
                    -Dsonar.cfamily.gcov.xmlReportPaths=coverage.xml \
                    -Dsonar.cpp.file.suffixes=.cpp,.h,.hpp \
                    -Dsonar.c.file.suffixes=.c \
                    -Dsonar.sourceEncoding=UTF-8 \
                    -Dsonar.working.directory=.scannerwork

            - name: Publish test results to GitHub (show tests in Checks)
              uses: dorny/test-reporter@v1
              if: always()
              with:
                  name: PlatformIO Tests
                  path: test-results/results.xml
                  reporter: java-junit

            # Optional: Upload coverage.xml as an artifact for debugging
            # - name: Upload coverage report
            #   uses: actions/upload-artifact@v4
            #   with:
            #     name: coverage-report
            #     path: coverage.xml
